---
title: MacroSheds Discharge and Chemistry Data Retrieval, Preparation, and Flux Calculation 
author: Weston Slaughter, Spencer Rhea, Mike Vlah
subtitle: using the MacroSheds package to retrieve discharge and chemistry data for target sites and variables, as well as preparing data for and performing flux calculation 
output:
  html_document:
    toc: true 
    theme: united
    highlight: zenburn
    df_print: kable
---



this walkthrough is from the persepctive of a first time user, with some knowledge of the R programming language. This example user, for a college project, needs to compare the flux of nitrate between two watersheds, one from the Eastern US and one from the Western US, each with at least 60 years of data.


# Install and explore the MacroSheds package


to use the MacroSheds package, you must first **make sure you have the MacroSheds package on your computer, built, and installed in R**. Currently, the package is only available via github. If you have no already, you can install the MacroSheds package as folows: 

```{r ms-install, eval = FALSE}
library(devtools)

devtools::install_github("https://github.com/MacroSHEDS/macrosheds")
```

now, that we have the MacroSheds package,  we load it into our library, along with other packages we will be using in this walkthrough. 

```{r setup-library}
   
library(macrosheds)
library(dplyr)
library(ggplot2)

```

In this walkthrough, to learn more about the MacroSheds package, its functions, and how to use them, we will be using the MacroSheds package's documentation. 

Before anything else, we need to know what functions we have available. Let's explore the package with `help()`

```{r ms-help}
help(package = macrosheds)
```


# Identify target sites and variables in the MacroSheds dataset


Our first goal is to **identify sites we might want to pull preliminary data from**. To get more information about MacroSheds' sites, we will use the function `download_ms_site_data`, which loads a tibble of MacroSheds site metadata. 

We will use `?` to get more information about the function, and how to use it.


#### ms\_download\_site\_data


```{r ms-site-data}
?ms_download_site_data
```

looks like the function will run with no arugments, let's run it and look at the results.

```{r ms-sites}
ms_sites <- ms_download_site_data()
colnames(ms_sites)
```

Our objective is to find 2 watersheds, one in the Eastern US and one in the Western US, which both have at least 20 years of nitrate data.

Our `ms_sites` dataframe columns include "latitude", "longitude", "first\_record_\utc", and "last\_record\_utc". Let's use these to see what sites meet our needs.


```{r ms-site-filter}
sixty_yrs_days <- 365 * 60

target_sites <- ms_sites %>%
    # eastern US < 90*W , western US > 110*W 
    # to make sure our sites are roughly western or eastern 
    filter(longitude > -95 | longitude < -115) %>%
    mutate(
        period = as.numeric(
            difftime(
                last_record_utc,
                first_record_utc,
                units = "days"
         ))) %>%
    filter(period > sixty_yrs_days)
  
  
unique(target_sites$domain)
head(target_sites)

target_summary <- target_sites %>%
    group_by(domain) %>%
    summarize(
         mean_long = mean(longitude),
         sum_obs = sum(n_observations),
         min_date = min(first_record_utc),
         max_date = min(last_record_utc)
  )

head(target_summary)
```

From our filter of the site metadata, we have found three domains which have site data that meets our requirements. By summarising the data, we've found that two of these sites are on the east coast (Fernow, HBEF) and one is on the West Coast (HJ Andrews). Our objective is to compare two sites, one east and one west, and between Fernow and HBEF our summary data shows that HBEF has a greater number of overall observations, so we will choose HBEF. 


#### ms\_download\_variables


To get data for our target variable, Nitrate, let's make sure it's in the MacroSheds variable catalog, and see exactly what it is called. For this, we will use `ms_download_variables`, which also does not need arguments. 

```{r ms-vars}
ms_vars <- ms_download_var_catalog()
head(ms_vars)
```


This is a pretty long list, let's do a siple text search to see what variables start with "Nitr"

```{r ms-vars-filter}
ms_NO3 <- ms_vars[grep("^Nitrate", ms_vars$variable_name),]
ms_NO3 <- ms_NO3[order(-ms_NO3$observations),]

unique(ms_NO3$site_code)[1:20]

```

There's a ton of results here, but I can see Nitrate, and it's variable code 'NO3'. 


# Retrieve discharge data for target sites


Now, we will retrieve our target data: discharge and nitrate for our two sites. First, we make a directory to save the data to, and save a vector of our target domain names. 

``` {r ms-dir}
my_ms_dir <- "./example/data"
my_domains <- c("hbef", "hjandrews")
```

We will also take a look at `ms_download_core_data` which we will sue to retrieve all the available data for our domains of interest.


##### ms\_download\_core\_data


```{r}
?ms_download_core_data
```

Now, we retrieve MacroSheds data by domain and save it to our directory.

``` {r ms-data, eval = FALSE}
ms_download_core_data(
    my_ms_dir,
    domains = my_domains,
    quiet = FALSE
)
```


##### ms\_load\_product    *discharge*


Now we have our data downloaded, but we want to load exactly the variables we need from into our R session. To do this, we use `ms_load_product`. 

```{r ms-load}
?ms_load_product
```

Pointing to the directory we downloaded the data to, we use this function to pull out discharge data for two sites.

```{r ms-q}
my_q <- ms_load_product(
    my_ms_dir,
    "discharge",
    site_codes = c("w1", "GSWS09"),
    sort_result = TRUE,
    warn = TRUE
)
```



# Retrieve stream chemistry data for target sites


#### ms\_load\_product    *chemistry*
Now that we have discharge, we will use `ms_load_product` again, but for Nitrate data.

```{r ms-chem-error, error = TRUE}
my_chem <- ms_load_product(
    my_ms_dir,
    "stream_chemistry",
    filter_vars = "NO3",
    site_codes = c("w1", "GSWS09"),
    sort_result = TRUE,
    warn = TRUE
)
```

As of 4/11/2022 this function returns the error message `None of filter_vars present in this dataset`, meaning that Nitrate's variable code `NO3` did not match with any of the data for these sites. 

All is not lost, it is common for sites to report, instead of NO3 concntration, `NO3_N` which is a measure of just the Nitrogen component of Nitrate. We can also see that NO3_N is listed in the variable search we did for variable names that start with "Nitr" earlier. Let's try again for this one. 

```{r ms-chem}
my_chem <- ms_load_product(
    my_ms_dir,
    "stream_chemistry",
    filter_vars = "NO3_N",
    site_codes = c("w1", "GSWS09"),
    sort_result = TRUE,
    warn = TRUE
)

head(my_chem)
```

# Manipulate and clean data


#### ms\_synchronize\_timestep


Now, we have to correct for sample number differences

```{r ms-sync}
?ms_synchronize_timestep

my_chem_sync <- ms_synchronize_timestep(
                  my_chem,
                  "1 day",
                  40
                )
```

# Calculate flux from this data


#### ms\_calc\_flux


Success! Now, let's use `ms\_calc\_flux` to use our discharge and chemistry data to calculate Nitrate-Nitrogen flux for our target sites. 

```{r}
?ms_calc_flux
```

we can plug in our discharge and chemistry data directly. 

```{r ms-flux}
my_flux <- ms_calc_flux(chemistry = my_chem_sync,
                        q = my_q,
                        q_type = 'discharge',
                        site_info = ms_sites
                        )
head(my_flux)
```

from the documentation of 'ms\_calc\_flux' we know that, based on our input flow type ('discharge' as opposed to 'precipitation'), that our flux units are 'kg/T' where T is the sampling interval. However, we are comparing between two very different watersheds- and it would be appropriate to scale by area. MacroSheds provides'ms\_scale\_flux\_by\_area' for this very purpose.


#### ms\_scale\_flux\_by\_area


```{r ms-scale}
my_flux_scaled <- ms_scale_flux_by_area(my_flux)
```

looks great -- let's plot it!

```{r ms-explore}
my_annual_mean_flux <- my_flux_scaled %>%
    mutate(year = as.numeric(format(as.Date(datetime), format="%Y"))) %>%
    group_by(year, site_code) %>%
    summarize(
      mean_flux = sum(val),
      n = n()
    ) %>%
    filter(n > 330)
  
ggplot(data=my_annual_mean_flux, aes(x=year, y=mean_flux, group=site_code)) +
    geom_line(aes(color=site_code))+
    geom_point() +
    ggtitle("Nitrate Flux (kg/ha/day)") +
    theme_minimal()
```
