---
title: MacroSheds Discharge and Chemistry Data Retrieval and Flux Calculation 
author: Weston Slaughter, Spencer Rhea, Mike Vlah
subtitle: Using the `macrosheds` package to retrieve discharge and chemistry data for target sites and variables, and to use it to calculate stream solute flux
output:
    html_document:
      toc: true 
      theme: united
      highlight: zenburn
      df_print: kable
---



This walkthrough is from the perspective of a first time user, with some knowledge of the R programming language. This example user, for a college project, needs to compare the flux of nitrate between two watersheds, one from the Eastern US and one from the Western US, each with at least 60 years of data.


# Install and explore the `macrosheds` package


To use the `macrosheds` package, you must first **make sure you have the `macrosheds` package on your computer, built, and installed in R**. Currently, the package is only available via github. If you have not already, you can install the `macrosheds` package as follows: 

```{r ms-install, eval = FALSE}
# install.packages('devtools') #you may need to install devtools too

devtools::install_github("https://github.com/MacroSHEDS/macrosheds")
```

Now, that we have the `macrosheds` package,  we load it into our library, along with other packages we will be using in this walkthrough. 

```{r setup-library, message = FALSE}
   
library(macrosheds)
library(dplyr)
library(ggplot2)

```

In this walkthrough, to learn more about the `macrosheds` package, its functions, and how to use them, we will be using the `macrosheds` package's documentation. 

Before anything else, we need to know what functions are available. Let's explore the package with `help()`

```{r ms-help}
help(package = macrosheds)
```


# Identify target sites and variables in the MacroSheds dataset


Our first goal is to **identify sites we might want to pull data from**. To get more information about MacroSheds sites, we will use the function `download_ms_site_data`, which loads a tibble of MacroSheds site metadata. 

We will use `?` to get more information about the function, and how to use it.


#### ms\_download\_site\_data


```{r ms-site-data}
?ms_download_site_data
```

Looks like the function will run with no arugments, let's run it and look at the results.

```{r ms-sites}
ms_sites <- ms_download_site_data()
colnames(ms_sites)
```

Our objective is to find 2 watersheds, one in the Eastern US and one in the Western US, which both have at least 60 years of nitrate data.

The `ms_sites` dataframe columns include "latitude", "longitude", "first\_record\_utc", and "last\_record\_utc". Let's use these to see what sites meet our needs.


```{r ms-site-filter}
sixty_yrs_days <- 365 * 60

target_sites <- ms_sites %>%
    # to make sure our sites are roughly western or eastern 
    filter(longitude > -95 | longitude < -115) %>%
    mutate(period = as.numeric(
        difftime(last_record_utc,
                 first_record_utc,
                 units = "days"
    ))) %>%
    filter(period > sixty_yrs_days)
    
    
unique(target_sites$domain)
head(target_sites)
  
target_summary <- target_sites %>%
    group_by(domain) %>%
    summarize(
        mean_long = mean(longitude),
        sum_obs = sum(n_observations),
        min_date = min(first_record_utc),
        max_date = min(last_record_utc)
    )
  
head(target_summary)
```

From our filter of the site metadata, we have found three domains which have site data that meets our requirements. By summarizing the data, we've found that two of these sites are in the Northeastern US (Fernow, HBEF) and one is on the West Coast (HJ Andrews). Our objective is to compare two sites, one east and one west, and between Fernow and HBEF our summary data show that HBEF has a greater number of overall observations, so let's go with that. 


#### ms\_download\_variables


To get data for our target variable, nitrate, let's make sure it's in the MacroSheds variable catalog, and see exactly what it is called. For this, we will use `ms_download_variables`, which also does not need arguments. 

```{r ms-vars}
ms_vars <- ms_download_variables()
head(ms_vars)
```


This is a pretty long list, let's do a simple text search to see what variables start with "nitr"

```{r ms-vars-filter}
ms_vars[grep("^nitr", ms_vars$variable_name, ignore.case = TRUE),]
```

There's a ton of results here, but I can see nitrate, and its variable code: 'NO3'. 


# Retrieve discharge data for target sites


Now, we will retrieve the target data: discharge and nitrate for our two sites. First, we choose a directory to save the data to, and create a vector of target domain names. 

``` {r ms-dir}
my_ms_dir <- "./data"
my_domains <- c("hbef", "hjandrews")
```

We will also take a look at `ms_download_core_data` which we will use to retrieve all the available data for the target domains.


##### ms\_download\_core\_data


```{r}
?ms_download_core_data
```

Now, we retrieve MacroSheds data by domain and save it to our directory.

``` {r ms-data, eval = FALSE}
options(timeout = 600) #default 60 might not be enough if your connection is slow

ms_download_core_data(
    my_ms_dir,
    domains = my_domains,
    quiet = FALSE
)
```


##### ms\_load\_product    *discharge*


Now we have the data downloaded, but we want to load specific variables into the R session. To do this, we use `ms_load_product`. 

```{r ms-load}
?ms_load_product
```

Pointing to the directory we downloaded the data to, we use this function to pull out discharge data for two sites.

```{r ms-q}
my_q <- ms_load_product(
    my_ms_dir,
    prodname = "discharge",
    site_codes = c("w1", "GSWS09"),
    sort_result = TRUE,
    warn = TRUE
)
```



# Retrieve stream chemistry data for target sites


#### ms\_load\_product    *chemistry*
Now that we have discharge, we will use `ms_load_product` again, but for nitrate data.

```{r ms-chem-error, error = TRUE}
my_chem <- ms_load_product(
    my_ms_dir,
    prodname = "stream_chemistry",
    filter_vars = "NO3",
    site_codes = c("w1", "GSWS09"),
    sort_result = TRUE,
    warn = TRUE
)
```

As of 4/11/2022 this function returns the error message `None of filter_vars present in this dataset`, meaning that nitrate's variable code `NO3` did not match with any of the data for these sites. 

All is not lost, it is common for sites to report, instead of NO3 concntration, `NO3_N` which is a measure of just the Nitrogen component of nitrate. We can also see that NO3_N is listed in the variable search we did for variable names that start with "Nitr" earlier. Let's try again for this one. 

```{r ms-chem}
my_chem <- ms_load_product(
    my_ms_dir,
    prodname = "stream_chemistry",
    filter_vars = "NO3_N",
    site_codes = c("w1", "GSWS09"),
    sort_result = TRUE,
    warn = TRUE
)

head(my_chem)
```

# Manipulate and clean data


#### ms\_synchronize\_timestep


Now, we have to correct for sample number differences

```{r ms-sync, message = FALSE}
?ms_synchronize_timestep

my_chem_sync <- ms_synchronize_timestep(
    my_chem,
    desired_interval = "1 day",
    impute_limit = 40
)
```

# Calculate flux from this data


#### ms\_calc\_flux


Success! Now, let's use `ms_calc_flux` to calculate nitrate-nitrogen flux from discharge and concentration. 

```{r}
?ms_calc_flux
```

We can plug in our discharge and chemistry data directly. 

```{r ms-flux}
my_flux <- ms_calc_flux(
    chemistry = my_chem_sync,
    q = my_q,
    q_type = 'discharge'
)
head(my_flux)
```

From the documentation of `ms_calc_flux` we know, based on our input flow type ('discharge' as opposed to 'precipitation'), that our flux units are `kg/T` where T is the sampling interval. However, we are comparing between two very different watersheds- and it would be appropriate to scale by area. MacroSheds provides`ms_scale_flux_by_area` for this very purpose.


#### ms\_scale\_flux\_by\_area


```{r ms-scale}
my_flux_scaled <- ms_scale_flux_by_area(my_flux)
```

Looks great -- let's plot it!

```{r ms-explore}
my_annual_mean_flux <- my_flux_scaled %>%
    mutate(year = as.numeric(format(as.Date(datetime), format="%Y"))) %>%
    group_by(year, site_code) %>%
    summarize(
        mean_flux = sum(val),
        n = n(),
        .groups = 'drop',
    ) %>%
    filter(n > 330)

ggplot(data=my_annual_mean_flux, aes(x=year, y=mean_flux, group=site_code)) +
    geom_line(aes(color=site_code))+
    geom_point() +
    ggtitle("Nitrate-N Flux (kg/ha/day)") +
    theme_minimal()
```
