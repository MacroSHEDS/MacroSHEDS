---
title: MacroSheds data retrieval and flux methods
author: Weston Slaughter, Mike Vlah, Spencer Rhea
subtitle: Retrieving discharge, precipitation, and chemistry data to compute solute fluxes and annual loads
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MacroSheds data retrieval and flux calculation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

See https://aslopubs.onlinelibrary.wiley.com/doi/full/10.1002/lol2.10325 for background.

You can use [macrosheds.org](https://macrosheds.org) to explore the full dataset, and to identify sites that
fit your needs.

The complete dataset, including all metadata, is available on [EDI](https://portal.edirepository.org/nis/mapbrowse?scope=edi&identifier=1262).

---

# Install and load the macrosheds package

```{r ms-install, eval = FALSE}
# install.packages('devtools') #you may need to install devtools too
remotes::install_github('MacroSHEDS/macrosheds')
library(macrosheds)

help(package = macrosheds)
```

# Identify target sites and variables

Let's say we're looking for watersheds with pre-1970 data records that are still in operation.

```{r ms-site-data}
?ms_load_sites

ms_sites <- ms_load_sites()
colnames(ms_sites)

ms_sites %>% 
    filter(site_type == 'stream_gauge',
           first_record < as.Date('1970-01-01'),
           last_record > as.Date('2020-01-01')) %>% 
    select(domain, site_code, first_record, last_record) %>% 
    print(n = 100)
```

And maybe we're interesting in nitrate.

```{r nitrate meta}
ms_load_variables(var_set = 'timeseries') %>% 
    filter(grepl('nitrate', variable_name, ignore.case = TRUE)) %>% 
    distinct(variable_code, variable_name)

ms_load_variables(var_set = 'timeseries_by_site') %>% 
    filter(variable_code == 'NO3_N', #MacroSheds doesn't store NO3 data, but you can convert NO3-N using ms_conversions()
           observations > 1000) %>% 
    distinct(domain) %>% 
    pull()
```

# Retrieve and load time-series data

HBEF and H. J. Andrews look like good candidates. Next, retrieve discharge and nitrate data for one site from each domain.
You can have as many `macrosheds_root` directories as you like, but they should only be used for MacroSheds data.

```{r}
my_domains <- c('hbef', 'hjandrews')
my_sites <- c('w7', 'GSWS07')
my_ms_dir <- './example/data'
options(timeout = 300) #default 60 seconds might not be enough if your connection is slow

ms_download_core_data(
    macrosheds_root = my_ms_dir,
    domains = my_domains #use "all" to retrieve all networks, domains, and sites.
)

my_q <- ms_load_product(
    my_ms_dir,
    prodname = 'discharge',
    site_codes = my_sites
)

my_chem <- ms_load_product(
    my_ms_dir,
    prodname = 'stream_chemistry',
    filter_vars = 'NO3_N',
    site_codes = my_sites
)

head(my_chem)
```

# Calculate flux and load

This yields daily nitrate-N fluxes and annual nitrate-N loads (i.e. cumulative fluxes) for stream water.
Note that you can also retrieve these quantities directly using `ms_load_product`.

```{r ms-flux}
no3_flux <- ms_calc_flux(my_chem, my_q)

#you can convert flux from kg/ha/d to kg/d (and back)
ms_undo_scale_flux_by_area(no3_flux)

plot()
```

```{r ms-load}
no3_load <- ms_calc_load(my_chem, my_q)
```
As you can see from the warnings, not all load methods are appropriate. Consider
the `ms_recommended` column and check the docs (`?ms_calc_load`) and these references for more information:

 + Aulenbach, B. T., Burns, D. A., Shanley, J. B., Yanai, R. D., Bae, K., Wild, A. D., Yang, Y., & Yi, D. (2016). Approaches to stream solute load estimation for solutes with varying dynamics from five diverse small watersheds. Ecosphere, 7(6), e01298.
 + Gubbins N. J., Slaughter, W. M., Vlah, M. J., Rhea, S., McDowell, W. H., Ross, M. R. V., & Bernhardt, E. S. (in review). An Assessment of Annual Load Estimation Methods in Small Watersheds for Cross Site Comparisons. https://eartharxiv.org/repository/view/6513/
 
 ```{r PRISM flux}
 
 ```
